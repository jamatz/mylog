<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <title>ECMAUnit Tests</title>
    <script language="JavaScript" type="text/javascript" src="chrome://mylog/content/mylog.js"></script>
    <script language="JavaScript" type="text/javascript" src="chrome://mylog/content/mylog-datastorage.js"></script>
    <script type="text/javascript" src="chrome://mylog/content/test/ecmaunit.js"> </script>
    <script type="text/javascript">
//<![CDATA[
        function TestTestCase() {
            this.name = 'TestTestCase';
            var le, dataStore, blankDataHandler;
            var url, title, tags, comment1, comment2, commment3, commments;
         
            this.setUp = function() {

				dataStore = new XmlDataStore();
				dataStore.setXmlFilepath("mylog-datastorage-test.xml"); // Shouldn't exist first time. We're starting from scratch.
				blankDataHandler = dataStore.open();
				dataStore.close(blankDataHandler);

				// Create default LogEntry
                url = "http://www.google.com";
                title = "Google search engine";
                tags = new Array("tag1","tag2","tag3");
                comments = new Array("comment1", "comment2", "comment3");

                le = new LogEntry();
                le.setUrl(url);
                le.setTitle(title);
                for (var i = 0; i < tags.length; i++) {
                        le.addTag(tags[i]);
                }
                for (var i = 0; i < comments.length; i++) {
                        le.addComment(comments[i]);
                }

                var doc = document.implementation.createDocument("", "", null);
                var entriesElem = doc.createElement("entries");
                entriesElem.setAttribute("counter", "0");
                doc.appendChild(entriesElem);
            }

            this.testAddEntry = function() {
				var dataHandler = dataStore.open();
				dataHandler.addEntry(le);
				dataStore.close(dataHandler);

				var secondDataHandler = dataStore.open();
				var entries = secondDataHandler.getAllEntries();

				this.assertEquals(entries.length, 1);
				this.assertEquals(le.getUrl(), entries[0].getUrl());
				this.assertEquals(le.getTitle(), entries[0].getTitle());
				this.assertEquals(le.getTags(), entries[0].getTags());
				this.assertEquals(le.getComments(), entries[0].getComments());
				dataStore.close(secondDataHandler);
            }

			this.testReplaceEntry = function() {
				var dataHandler = dataStore.open();
				dataHandler.addEntry(le);
				dataStore.close(dataHandler);
				
				var secondDataHandler = dataStore.open();
				var entries = secondDataHandler.getAllEntries();
				var newUrl = "http://newurl.com/";
				entries[0].setUrl(newUrl);
				secondDataHandler.replaceEntry(entries[0]);
				dataStore.close(secondDataHandler);

				var thirdDataHandler = dataStore.open();
				entries = thirdDataHandler.getAllEntries();
				this.assertEquals(entries.length, 1);
				this.assertEquals(entries[0].getUrl(), newUrl);
				this.assertEquals(le.getTitle(), entries[0].getTitle());
				this.assertEquals(le.getTags(), entries[0].getTags());
				this.assertEquals(le.getComments(), entries[0].getComments());
				this.assertEquals(entries[0].getId(), 0);
				dataStore.close(thirdDataHandler);

			}
            
            this.testRemoveEntry = function() {
				var dataHandler = dataStore.open();
				dataHandler.addEntry(le);
				dataStore.close(dataHandler);

				var secondDataHandler = dataStore.open();
				var entries = secondDataHandler.getAllEntries();
				var id = entries[0].getId();
				secondDataHandler.removeEntry(id);

				entries = secondDataHandler.getAllEntries();
				this.assertEquals(entries.length, 0);
				
				secondDataHandler.removeEntry(id); // Try removing again: should not crash
				entries = secondDataHandler.getAllEntries();
				this.assertEquals(entries.length, 0);

				dataStore.close(secondDataHandler);
            }
            
            this.tearDown = function() {
				dataStore.open();
				dataStore.close(blankDataHandler); // So we can start from scratch again.
            }
        }
        TestTestCase.prototype = new TestCase;

        function runTests() {
            placeholder = document.getElementById('placeholder');
            var testsuite = new TestSuite(new HTMLReporter(placeholder));
            testsuite.registerTest(TestTestCase);
            testsuite.runSuite();
        }
//]]>
</script>
</head>

<body onload="runTests()">
<h3>EcmaUnit tests for MyLog datastorage</h3>
<div id="placeholder"> </div>
</body>
</html>
